<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>Create Player Account</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    .auth-card{max-width:440px;margin:10vh auto;padding:1.75rem;border-radius:16px;background:#111;color:#fff}
    .auth-card form{display:grid;gap:1rem}
    .auth-card input[type="text"],.auth-card input[type="password"]{width:100%;padding:.75rem;border-radius:10px;border:1px solid #333;background:#0b0b0b;color:#fff}
    .auth-card button{padding:.85rem 1rem;border:0;border-radius:12px;cursor:pointer}
    .error{display:none;color:#ff6b6b;font-size:.9rem}
    label.consent{display:flex;gap:.5rem;align-items:flex-start;font-size:.9rem}
  </style>
</head>
<body>
  <main class="auth-card">
    <h1>Create account</h1>
    <p>Players sign in with username + password. No email/phone required.</p>

    <form id="signupForm">
      <label>Username
        <input id="su" name="username" type="text" minlength="3" maxlength="24" pattern="[A-Za-z0-9_]+" title="3–24 characters: letters, numbers, underscore only" autocomplete="username" required autofocus />
      </label>

      <label>Password
        <input id="sp" name="password" type="password" minlength="8" autocomplete="new-password" required
               pattern="(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9])(?=.*[!@#$%^&*]).{8,}"
               title="Password must be at least 8 characters and include one uppercase letter, one lowercase letter, one number, and one special symbol." />
      </label>
      
      <label>Confirm password
        <input id="sp2" name="passwordConfirm" type="password" minlength="8" autocomplete="new-password" title="Re-enter the same password" required />
      </label>
      
      <small style="color:#bbb;display:block;margin-top:-.5rem;margin-bottom:1rem;">
        Must be at least 8 characters and include 1 uppercase letter, 1 lowercase letter, 1 number, and 1 special symbol.
      </small>
      
      <label style="display:flex;align-items:center;gap:.5rem;font-size:.9rem">
        <input id="showpw" type="checkbox" />
        <span>Show password</span>
      </label>

      <label>First name
        <input id="sf" name="firstName" type="text" maxlength="30" autocomplete="given-name" required
               pattern="[A-Za-z ]+"
               oninput="this.value=this.value.replace(/[^A-Za-z ]/g,'')"
        />
      </label>

      <label>Last initial
        <input id="sl" name="lastInitial" type="text" maxlength="1" title="One letter A–Z" required
               pattern="[A-Za-z]"
               oninput="this.value = this.value.replace(/[^A-Za-z]/g,'').toUpperCase().slice(0,1)"
        />
      </label>

      <label class="consent">
        <input id="consent" name="consent" type="checkbox" required />
        <span>Parent/guardian confirms account creation for a minor and agrees to program terms.</span>
      </label>

      <button type="submit">Create Account</button>
      <div id="serr" class="error" role="alert" aria-live="polite"></div>
    </form>

    <p style="margin-top:.75rem;">Already have an account? <a href="/login.html">Sign in</a></p>
  </main>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('signupForm');
    const serr = document.getElementById('serr');
    const show = document.getElementById('showpw');
    const p1 = document.getElementById('sp');
    const p2 = document.getElementById('sp2');

    // wire show/hide once
    if (show && p1 && p2) {
      show.addEventListener('change', () => {
        const t = show.checked ? 'text' : 'password';
        p1.type = t; p2.type = t;
      });
    }

    if (!form) return;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      serr.style.display = 'none';
      serr.textContent = '';
      serr.setAttribute('role','alert');
      serr.setAttribute('aria-live','polite');

      // basic client checks
      const username = document.getElementById('su').value.trim();
      const password = p1.value;
      const passwordConfirm = p2.value;
      const firstName = document.getElementById('sf').value.trim();
      const lastInitial = document.getElementById('sl').value.trim();
      const consent = document.getElementById('consent').checked;

      if (!consent) {
        serr.textContent = 'Consent required';
        serr.style.display = 'block';
        return;
      }
      if (password !== passwordConfirm) {
        serr.textContent = 'Passwords do not match';
        serr.style.display = 'block';
        return;
      }

      const btn = form.querySelector('button[type="submit"]');
      btn && (btn.disabled = true);

      try {
        const r = await fetch('/api/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password, passwordConfirm, firstName, lastInitial })
        });

        const data = await r.json().catch(() => ({}));
        if (!r.ok || !data.ok) {
          throw new Error(data.error || 'Signup failed');
        }

        // success -> go to login
        window.location.href = '/login.html';
      } catch (err) {
        let msg = err && err.message ? err.message : 'Signup failed';
        try {
          const resp = await fetch('/api/signup', { method: 'POST' });
        } catch {}
        // If the previous fetch threw, we already have msg. But try to surface any server detail from last response if we captured it above
        serr.textContent = msg;
        serr.style.display = 'block';
        serr.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } finally {
        btn && (btn.disabled = false);
      }
    });
  });
  </script>
</body>
</html>