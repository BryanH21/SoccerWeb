<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="robots" content="noindex,nofollow"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Player Profile & Roadmap</title>
  <link rel="stylesheet" href="/soccer.css">
  <style>
    :root{
      --bg:#0e0f12; --card:#15161a; --soft:#1d1f24;
      --text:#f5f7fb; --dim:#aeb4c2;
      --accent:#f5c542; --ring:#1e2127; --ok:#9BE28B; --err:#ff6b6b;
    }
    body{ background:var(--bg); color:var(--text); }
    .wrap{ max-width:1100px; margin:0 auto; padding:2rem 1rem; }
    h1{ margin:0 0 .35rem; font-size:1.9rem; }
    .sub{ color:var(--dim); margin:0 0 1.25rem; }

    .card{
      background:linear-gradient(180deg,var(--card),var(--soft));
      border:1px solid var(--ring); border-radius:18px; padding:1rem;
      box-shadow:0 8px 24px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.02);
    }
    .grid3{ display:grid; gap:1rem; grid-template-columns:1fr; }
    @media (min-width:820px){ .grid3{ grid-template-columns:1.1fr .9fr .9fr; } }
    .titleband{ display:flex; align-items:center; gap:.5rem; font-weight:800; letter-spacing:.02em; }
    .chip{ display:inline-flex; align-items:center; gap:.35rem; font-size:.7rem; padding:.2rem .55rem; border-radius:999px; border:1px solid rgba(245,197,66,.35); color:var(--accent); background:rgba(245,197,66,.12); text-transform:uppercase; letter-spacing:.06em; }

    .kpi{ background:#0f1014; border:1px solid #20232a; border-radius:12px; padding:.75rem; }
    .kpi .label{ color:var(--dim); font-size:.8rem; }
    .kpi .value{ font-weight:800; margin-top:.2rem; }

    .section{ margin-top:1rem; }
    .section h3{ margin:.25rem 0 .6rem; }
    .list{ display:flex; flex-direction:column; gap:.45rem; }
    .item{ background:#0f1014; border:1px solid #20232a; border-radius:10px; padding:.5rem .65rem; display:flex; align-items:center; gap:.6rem; }
    .item.done{ opacity:.7; text-decoration:line-through; }
    .time{ color:#aeb4c2; font-size:.85rem; }

    /* Roadmap */
    .mapwrap{ margin-top:1rem; background:#0f1014; border:1px solid #20232a; border-radius:14px; padding:1rem; }
    .map{ width:100%; height:180px; }
    .flag { cursor:pointer; }
    .tip{ position:fixed; inset:auto auto 1rem 1rem; background:#15161a; color:#f5f7fb; border:1px solid #2a2f39; border-radius:12px; padding:.6rem .8rem; box-shadow:0 10px 30px rgba(0,0,0,.45); display:none; max-width:min(90vw,360px); }
    .tip .t{ font-weight:800; }
    .tip .s{ color:var(--dim); font-size:.9rem; margin-top:.2rem; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Player Profile & Roadmap</h1>
    <p class="sub">Private player dashboard.</p>

    <!-- Membership summary -->
    <div class="card">
      <div class="titleband"><span class="chip">Membership</span> <span>Current Plan</span></div>
      <div class="grid3" style="margin-top:.75rem;">
        <div class="kpi"><div class="label">Plan</div><div id="k-plan" class="value">—</div></div>
        <div class="kpi"><div class="label">Next Payment</div><div id="k-next" class="value">—</div></div>
        <div class="kpi"><div class="label">Renews On</div><div id="k-renew" class="value">—</div></div>
      </div>
    </div>

    <!-- Goals & Milestones + Roadmap -->
    <div class="card section">
      <div class="titleband"><span class="chip">Roadmap</span> <span>Goals & Milestones</span></div>

      <div class="section">
        <h3>Goals</h3>
        <div id="goals" class="list"><div class="item">Loading…</div></div>
      </div>

      <div class="section">
        <h3>Milestones</h3>
        <div id="miles" class="list"><div class="item">Loading…</div></div>
      </div>

      <div class="mapwrap">
        <svg id="roadmap" class="map" viewBox="0 0 1000 180" preserveAspectRatio="xMidYMid meet" aria-label="Training roadmap">
          <defs>
            <linearGradient id="p" x1="0" x2="1">
              <stop offset="0%" stop-color="#f5c542"/>
              <stop offset="100%" stop-color="#f5c542" stop-opacity=".35"/>
            </linearGradient>
          </defs>
          <rect x="20" y="90" width="960" height="6" rx="3" fill="url(#p)" opacity=".45"/>
          <!-- flags injected by JS -->
        </svg>
        <div id="tip" class="tip"><div class="t"></div><div class="s"></div></div>
      </div>
    </div>
  </div>

  <script>
  (async function(){
    // Load current user profile
    let me;
    try {
      const r = await fetch('/api/me');
      if(!r.ok) throw 0; me = await r.json();
    } catch {
      location.href = '/login.html'; return;
    }

    // Populate membership KPIs
    const fmt = (d)=> d ? new Date(d).toLocaleDateString() : '—';
    document.getElementById('k-plan').textContent  = me.plan || 'Not Assigned';
    document.getElementById('k-next').textContent  = fmt(me.next_payment_date);
    document.getElementById('k-renew').textContent = fmt(me.renewal_date);

    // Render goals
    const goalsEl = document.getElementById('goals');
    const goals = Array.isArray(me.goals) ? me.goals : [];
    goalsEl.innerHTML = '';
    if(!goals.length){ goalsEl.innerHTML = '<div class="item">No goals yet.</div>'; }
    else goals.forEach(g=>{
      const row = document.createElement('div');
      row.className = 'item';
      row.textContent = String(g);
      goalsEl.appendChild(row);
    });

    // Render milestones
    const milesEl = document.getElementById('miles');
    const miles = Array.isArray(me.milestones) ? me.milestones : [];
    milesEl.innerHTML = '';
    if(!miles.length){ milesEl.innerHTML = '<div class="item">No milestones yet.</div>'; }
    else miles.forEach(m=>{
      const row = document.createElement('div');
      row.className = 'item' + (m.done?' done':'');
      row.innerHTML = `<div style="width:10px;height:10px;border-radius:2px;background:${m.done?'var(--ok)':'#39414f'}"></div>
                       <div>
                         <div class="title">${escapeHtml(m.title||'(untitled)')}</div>
                         <div class="time">${escapeHtml(m.timeframe||'')}</div>
                       </div>`;
      milesEl.appendChild(row);
    });

    // Roadmap flags (click to show tooltip)
    const svg = document.getElementById('roadmap');
    const tip = document.getElementById('tip');
    const placeFlags = ()=>{
      // Clear previous
      [...svg.querySelectorAll('.flag')].forEach(n=>n.remove());
      const total = Math.max(miles.length, 1);
      miles.forEach((m, i)=>{
        const x = 40 + (i/(total-1||1))*920;
        const g = document.createElementNS('http://www.w3.org/2000/svg','g');
        g.setAttribute('class','flag');
        g.setAttribute('data-title', m.title||'Milestone');
        g.setAttribute('data-time',  m.timeframe||'');
        g.setAttribute('transform', `translate(${x}, 70)`);
        const pole = document.createElementNS('http://www.w3.org/2000/svg','rect');
        pole.setAttribute('x','0'); pole.setAttribute('y','0'); pole.setAttribute('width','3'); pole.setAttribute('height','36'); pole.setAttribute('fill','#2a2f39');
        const flag = document.createElementNS('http://www.w3.org/2000/svg','path');
        flag.setAttribute('d','M3 4 L50 14 L3 22 Z');
        flag.setAttribute('fill', m.done ? 'var(--ok)' : '#f5c542');
        flag.setAttribute('opacity', m.done?'.85':'1');
        g.appendChild(pole); g.appendChild(flag); svg.appendChild(g);
      });
      // Finish flag (larger)
      const end = document.createElementNS('http://www.w3.org/2000/svg','g');
      end.setAttribute('class','flag');
      end.setAttribute('data-title','Finish'); end.setAttribute('data-time','');
      end.setAttribute('transform','translate(960, 58)');
      const goal = document.createElementNS('http://www.w3.org/2000/svg','path');
      goal.setAttribute('d','M0 50 L0 0 L40 10 L0 20 Z');
      goal.setAttribute('fill','#f5c542');
      const post = document.createElementNS('http://www.w3.org/2000/svg','rect');
      post.setAttribute('x','-3'); post.setAttribute('y','0'); post.setAttribute('width','3'); post.setAttribute('height','60'); post.setAttribute('fill','#2a2f39');
      end.appendChild(post); end.appendChild(goal); svg.appendChild(end);
    };
    placeFlags();

    const wireFlag = (g)=>{
      const t = g.getAttribute('data-title')||'';
      const s = g.getAttribute('data-time')||'';
      const show = (ev)=>{
        tip.querySelector('.t').textContent = t;
        tip.querySelector('.s').textContent = s;
        tip.style.display='block';
      };
      const hide = ()=>{ tip.style.display='none'; };
      g.addEventListener('click', show, {passive:true});
      g.addEventListener('touchstart', show, {passive:true});
      document.addEventListener('click', (e)=>{ if(!svg.contains(e.target)) hide(); }, {passive:true});
      window.addEventListener('scroll', hide, {passive:true});
      window.addEventListener('resize', hide, {passive:true});
    };
    svg.querySelectorAll('.flag').forEach(wireFlag);

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
  })();
  </script>
</body>
</html>