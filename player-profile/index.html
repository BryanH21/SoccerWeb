<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="robots" content="noindex,nofollow"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Player Profile</title>
  <link rel="stylesheet" href="/soccer.css">
  <style>
    :root{
      --foundry-bg:#0e0f12; --foundry-card:#15161a; --foundry-soft:#1d1f24;
      --foundry-text:#f5f7fb; --foundry-dim:#aeb4c2;
      --foundry-accent:#f5c542; --foundry-accent-2:#283043;
    }
    body { background:var(--foundry-bg); color:var(--foundry-text); }
    .pp-wrap{ max-width:1100px; margin:0 auto; padding:2rem 1.25rem; }
    .pp-header h1{ font-size:2rem; margin:0 0 .25rem; }
    .pp-sub{ color:var(--foundry-dim); margin:0 0 1.25rem; }
    .pp-grid{ display:grid; grid-template-columns:1fr; gap:1.25rem; }
    @media (min-width:900px){ .pp-grid{ grid-template-columns:1fr 1fr; } .highlight{ grid-column:1 / -1; } }
    .pp-card{ background:linear-gradient(180deg,var(--foundry-card),var(--foundry-soft));
      border:1px solid #1e2127; border-radius:20px; padding:1.25rem;
      box-shadow:0 8px 24px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.02);
      position:relative; overflow:hidden;
    }
    .pp-card::after{ content:""; position:absolute; inset:-2px;
      background:conic-gradient(from 120deg at 50% 50%, transparent 0 35%, rgba(245,197,66,.18) 40%, transparent 60%);
      filter:blur(12px); z-index:0; pointer-events:none;
    }
    .pp-card *{ position:relative; z-index:1; }
    .pp-card-head{ display:flex; align-items:center; gap:.75rem; margin-bottom:.75rem; }
    .pp-card-head h2{ font-size:1.25rem; margin:0; }
    .pp-chip{ display:inline-block; font-size:.75rem; text-transform:uppercase; letter-spacing:.06em;
      padding:.25rem .5rem; border-radius:999px; background:rgba(245,197,66,.12); color:var(--foundry-accent); border:1px solid rgba(245,197,66,.35);
    }
    .pp-metrics{ display:grid; grid-template-columns:1fr; gap:.75rem; }
    @media (min-width:600px){ .pp-metrics{ grid-template-columns:repeat(3,1fr); } }
    .pp-metric{ background:#121318; border:1px solid #20232a; border-radius:14px; padding:.9rem; }
    .pp-metric label{ display:block; color:var(--foundry-dim); font-size:.8rem; margin-bottom:.25rem; }
    .pp-value{ font-size:1.1rem; font-weight:600; letter-spacing:.2px; }
    .pp-value.plan-3{ color:#8fd17e; } .pp-value.plan-6{ color:#6ec1ff; } .pp-value.plan-12{ color:var(--foundry-accent); }

    /* due banner */
    #dueBanner{ display:none; margin:.5rem 0 1rem; padding:.75rem 1rem; border-radius:12px;
      background:#271f07; border:1px solid #4e3e0c; color:#f5c542;
    }

    /* button */
    .btn{ background:var(--foundry-accent); color:#111; border:0; padding:.55rem .85rem; border-radius:12px; font-weight:700; cursor:pointer; }
  /* Bigger roadmap + tooltip */
  .pp-map { position:relative; margin-top: 1rem; background:#121318; border:1px solid #20232a; border-radius:14px; padding:1rem; }
  .pp-map svg { width:100%; height:auto; display:block; }
  .pp-tip {
    position:absolute; left:0; top:0; transform:translate(-50%,-110%);
    background:#0f1014; border:1px solid #3a3f4b; color:#f5f7fb;
    padding:.65rem .8rem; border-radius:10px; font-size:.95rem; line-height:1.2;
    box-shadow:0 10px 28px rgba(0,0,0,.45); pointer-events:none; white-space:nowrap;
  }
  .pp-tip .head{ font-weight:700; margin-bottom:.2rem; }
  .pp-tip .time{ color:#aeb4c2; font-size:.85rem; }

  /* visuals */
  .flag { fill: rgba(245,197,66,.22); stroke: rgba(245,197,66,.65); }
  .flag.done { fill: rgba(139, 214, 125, .22); stroke: rgba(139, 214, 125, .8); }
  .track { stroke:#2a2f39; stroke-width:8; }
  .track-progress { stroke:#f5c542; stroke-width:8; }
  .node { fill:#0f1014; stroke:#2a2f39; stroke-width:2.5; }
  .node.done { stroke:#9BE28B; }
  .player { fill:#f5c542; stroke:#111; stroke-width:2.5; }
  .finish-flag { fill: rgba(245,197,66,.35); stroke: rgba(245,197,66,1); }
  </style>
</head>
<body>
  <main class="pp-wrap">
    <header class="pp-header">
      <h1>Player Profile &amp; Roadmap</h1>
      <p class="pp-sub">Private player dashboard.</p>
      <div id="dueBanner">
        <strong>Heads up:</strong> Next payment is due in <span id="dueDays"></span> days.
      </div>
    </header>

    <section class="pp-grid">
      <article class="pp-card highlight">
        <div class="pp-card-head">
          <span class="pp-chip">Membership</span>
          <h2>Current Plan</h2>
        </div>
        <div class="pp-metrics">
          <div class="pp-metric">
            <label>Plan</label>
            <div id="pp-plan" class="pp-value">Loading…</div>
          </div>
          <div class="pp-metric">
            <label>Next Payment</label>
            <div id="pp-next" class="pp-value">Loading…</div>
          </div>
          <div class="pp-metric">
            <label>Renews On</label>
            <div id="pp-renew" class="pp-value">Loading…</div>
          </div>
        </div>
      </article>
      <article class="pp-card">
        <div class="pp-card-head">
          <span class="pp-chip">Roadmap</span>
          <h2>Goals &amp; Milestones</h2>
        </div>

        <div class="pp-metrics" id="pp-roadmap">
          <div class="pp-metric" style="grid-column:1/-1;">
            <label>Goals</label>
            <ul id="pp-goals" class="pp-value" style="list-style:disc;margin-left:1rem;"></ul>
          </div>
          <div class="pp-metric" style="grid-column:1/-1;">
            <label>Milestones</label>
            <ul id="pp-milestones" class="pp-value" style="list-style:disc;margin-left:1rem;"></ul>
          </div>
        </div>
        <div id="pp-map" class="pp-map" aria-label="Roadmap progress"></div>
      </article>

      <!-- space for future cards: Goals, Milestones, etc. -->
    </section>
  </main>

  <script>
  (async function(){
    try {
      const r = await fetch('/api/me');
      if (!r.ok) { location.href = '/login.html'; return; }
      const data = await r.json();
      console.log('ME profile:', data.profile);

      const plan = (data.profile?.plan || '').toLowerCase();
      const next = data.profile?.next_payment_date ? new Date(data.profile.next_payment_date) : null;
      const renew = data.profile?.renewal_date ? new Date(data.profile.renewal_date) : null;

      const fmt = d => d ? d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'}) : '—';

      const planEl = document.getElementById('pp-plan');
      const nextEl = document.getElementById('pp-next');
      const renewEl = document.getElementById('pp-renew');

      const label = plan==='3-month'?'3 Months': plan==='6-month'?'6 Months': plan==='12-month'?'12 Months':'Not Assigned';
      planEl.textContent = label;
      nextEl.textContent = fmt(next);
      renewEl.textContent = fmt(renew);

      // ---- Roadmap render (read-only) ----
      const goals = Array.isArray(data.profile?.goals) ? data.profile.goals : [];
      const milestones = Array.isArray(data.profile?.milestones) ? data.profile.milestones : [];

      const goalsEl = document.getElementById('pp-goals');
      const msEl = document.getElementById('pp-milestones');

      const renderList = (ul, items) => {
        ul.innerHTML = '';
        if (!items || items.length === 0) {
          const li = document.createElement('li');
          li.textContent = 'No items yet.';
          ul.appendChild(li);
          return;
        }
        for (const it of items) {
          const li = document.createElement('li');
          if (typeof it === 'string') {
            li.textContent = it; // simple string goal
          } else if (it && typeof it === 'object') {
            li.textContent = it.title || '(untitled)';
            if (it.done) {
              li.style.opacity = 0.8;
              li.style.textDecoration = 'line-through';
            }
          }
          ul.appendChild(li);
        }
      };

      if (goalsEl) renderList(goalsEl, goals);
      if (msEl) renderList(msEl, milestones);

      // ---- Visual Roadmap Map (SVG) ----
      const mapEl = document.getElementById('pp-map');
      if (mapEl) {
        // Normalize milestones to objects with {title, timeframe, done}
        const ms = (Array.isArray(milestones) ? milestones : []).map(m =>
          typeof m === 'string' ? ({ title: m, timeframe: '', done: false }) : ({ timeframe: '', ...m })
        );
        const n = ms.length;
        const doneCount = ms.filter(m => m && m.done).length;

        // Create (or reuse) tooltip node
        let tip = mapEl.querySelector('.pp-tip');
        if (!tip) {
          tip = document.createElement('div');
          tip.className = 'pp-tip';
          tip.style.display = 'none';
          mapEl.appendChild(tip);
        }
        const showTip = (xPx, title, timeframe) => {
          tip.innerHTML = `<div class="head">${title || '(untitled)'}</div>${timeframe ? `<div class="time">${timeframe}</div>` : ''}`;
          tip.style.left = `${xPx}px`;
          tip.style.top = `12px`;
          tip.style.display = 'block';
        };
        const hideTip = () => { tip.style.display = 'none'; };

        if (n === 0) {
          mapEl.innerHTML = '<div class="pp-value" style="padding:.5rem;">No milestones yet.</div>';
        } else {
          // Larger canvas
          const W = 1200, H = 260, PADX = 60;
          const usable = W - PADX*2;
          const step = usable / (n + 1);  // +1 for finish
          const y = Math.round(H * 0.62); // track height

          const idx = Math.min(doneCount, n);
          const playerX = PADX + step * idx;

          // Build flags (clickable)
          const flagGroups = [];
          for (let i = 0; i < n; i++) {
            const x = PADX + step * (i + 1) - step * 0.5;
            const isDone = !!ms[i].done;
            const title = ms[i].title || '';
            const timeframe = ms[i].timeframe || '';

            // Bigger flag
            const flagW = 18, flagH = 26, poleH = 34;
            const pole = `<line x1="${x}" y1="${y - poleH}" x2="${x}" y2="${y}" stroke="${isDone ? 'rgba(139,214,125,.9)' : '#4b5563'}" stroke-width="3"/>`;
            const tri  = `<path class="flag ${isDone ? 'done':''}" d="M ${x} ${y - poleH} L ${x + flagW} ${y - poleH + flagH/2} L ${x} ${y - poleH + flagH} Z"/>`;

            // large invisible hit-rect for easy taps
            const hit = `<rect x="${x - 20}" y="${y - poleH - 8}" width="${flagW + 48}" height="${poleH + 24}" fill="transparent" data-hit="1" />`;

            flagGroups.push(`
              <g class="flaggrp" data-i="${i}" data-title="${(title||'').replace(/"/g,'&quot;')}" data-time="${(timeframe||'').replace(/"/g,'&quot;')}" data-x="${x}">
                ${pole}${tri}${hit}
              </g>
            `);
          }

          // Finish: large flag instead of net
          const goalX = PADX + step * (n + 1);
          const finishW = 28, finishH = 42, finishPole = 52;
          const finishFlag = `
            <g class="finish">
              <line x1="${goalX}" y1="${y - finishPole}" x2="${goalX}" y2="${y}" stroke="rgba(245,197,66,1)" stroke-width="4"/>
              <path class="finish-flag" d="M ${goalX} ${y - finishPole} L ${goalX + finishW} ${y - finishPole + finishH/2} L ${goalX} ${y - finishPole + finishH} Z"/>
              <text x="${goalX + finishW + 8}" y="${y - finishPole + finishH/2 + 4}" fill="#f5f7fb" font-weight="700" font-size="14">Finish</text>
            </g>
          `;

          // Track + progress
          const trackStart = PADX, trackEnd = goalX;
          const progressEnd = playerX;

          // Nodes (start..finish)
          const nodes = [];
          for (let i = 0; i <= n; i++) {
            const nx = PADX + step * i;
            const completed = i <= doneCount;
            nodes.push(`<circle class="node ${completed ? 'done':''}" cx="${nx}" cy="${y}" r="9"></circle>`);
          }

          // Player marker
          const player = `<circle class="player" cx="${playerX}" cy="${y}" r="12"></circle>`;

          const svg = `
            <svg viewBox="0 0 ${W} ${H}" role="img" aria-label="Roadmap timeline">
              <line class="track" x1="${trackStart}" y1="${y}" x2="${trackEnd}" y2="${y}"></line>
              <line class="track-progress" x1="${trackStart}" y1="${y}" x2="${progressEnd}" y2="${y}"></line>

              ${nodes.join('')}
              ${flagGroups.join('')}
              ${finishFlag}
              ${player}
            </svg>
            <div class="tiny" style="margin-top:.6rem;color:#aeb4c2;">Progress: ${doneCount}/${n} milestones complete</div>
          `;

          mapEl.innerHTML = svg;

          // Wire up flag clicks to show tooltip
          const containerRect = mapEl.getBoundingClientRect();
          mapEl.querySelectorAll('.flaggrp').forEach(g => {
            g.addEventListener('click', e => {
              const xSvg = Number(g.getAttribute('data-x'));
              // Convert svg x to container px
              const xPct = (xSvg) / 1200;
              const xPx = Math.max(16, Math.min(containerRect.width - 16, xPct * containerRect.width));
              const title = g.getAttribute('data-title') || '';
              const time  = g.getAttribute('data-time') || '';
              showTip(xPx, title, time);
              e.stopPropagation();
            });
          });

          // Clicking empty space hides tooltip
          mapEl.addEventListener('click', () => hideTip());
        }
      }

      planEl.classList.remove('plan-3','plan-6','plan-12');
      if (plan.startsWith('3')) planEl.classList.add('plan-3');
      else if (plan.startsWith('6')) planEl.classList.add('plan-6');
      else if (plan.startsWith('12')) planEl.classList.add('plan-12');

      // Show “due soon” banner if ≤ 7 days
      if (next) {
        const days = Math.ceil((next - new Date()) / 86400000);
        if (days <= 7) {
          document.getElementById('dueDays').textContent = Math.max(0, days);
          document.getElementById('dueBanner').style.display = 'block';
        }
      }
    } catch (e) {
      document.getElementById('pp-plan').textContent = 'Error';
      document.getElementById('pp-next').textContent = 'Error';
      document.getElementById('pp-renew').textContent = 'Error';
    }
  })();
  </script>
</body>
</html>